name: action-validation

on:
  pull_request:
    branches:
      - dev
    paths:
      - '.github/actions/proxmox-openapi-artifacts/**'
      - '.github/workflows/action-validation.yml'
      - 'tools/automation/**'
      - 'tools/shared/**'
      - 'package.json'
      - 'package-lock.json'
      - 'tsconfig.json'
  push:
    branches:
      - dev
    paths:
      - '.github/actions/proxmox-openapi-artifacts/**'
      - '.github/workflows/action-validation.yml'
      - 'tools/automation/**'
      - 'tools/shared/**'
      - 'package.json'
      - 'package-lock.json'
      - 'tsconfig.json'

jobs:
  dist:
    name: Check committed dist
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        run: npm install
      - name: Rebuild action bundle
        run: npm run action:package
      - name: Detect dist drift
        run: |
          set -euo pipefail
          if ! git diff --quiet -- .github/actions/proxmox-openapi-artifacts/dist; then
            echo '::error::Bundled dist output is out of date. Run npm run action:package and commit the changes.'
            git diff --stat -- .github/actions/proxmox-openapi-artifacts/dist
            exit 1
          fi

  matrix-smoke:
    name: Smoke test (Node 24)
    needs: dist
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        shell: bash
        run: npm install
      - name: Build action bundle
        shell: bash
        run: npm run action:package
      - name: Run smoke test
        shell: bash
        run: |
          set -euo pipefail
          rm -rf tmp
          mkdir -p tmp/action-smoke tmp/action-work tmp/action-tools
          cp -R .github/actions/proxmox-openapi-artifacts/dist tmp/action-smoke/dist
          cp .github/actions/proxmox-openapi-artifacts/action.yml tmp/action-smoke/action.yml
          export GITHUB_ACTION_PATH="$(realpath tmp/action-smoke)"
          export GITHUB_WORKSPACE="$(pwd)"
          export RUNNER_TEMP="$(pwd)/tmp/action-work"
          export RUNNER_TOOL_CACHE="$(pwd)/tmp/action-tools"
          export GITHUB_OUTPUT="$RUNNER_TEMP/output"
          export GITHUB_STEP_SUMMARY="$RUNNER_TEMP/summary"
          export INPUT_MODE=ci
          export INPUT_OFFLINE=true
          export INPUT_FALLBACK_TO_CACHE=true
          export INPUT_INSTALL_COMMAND=
          export INPUT_INSTALL_PLAYWRIGHT_BROWSERS=false
          export INPUT_WORKING_DIRECTORY=.
          export INPUT_REPORT_PATH="$RUNNER_TEMP/summary.json"
          mkdir -p "$(dirname "$GITHUB_OUTPUT")" "$(dirname "$GITHUB_STEP_SUMMARY")"
          touch "$GITHUB_OUTPUT" "$GITHUB_STEP_SUMMARY"
          node tmp/action-smoke/dist/index.cjs
