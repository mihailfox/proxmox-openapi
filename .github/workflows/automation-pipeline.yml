name: automation-pipeline

on:
  pull_request:
    branches:
      - main
    paths:
      - .github/workflows/automation-pipeline.yml
      - package.json
      - package-lock.json
      - biome.json
      - tsconfig.json
      - vite.config.ts
      - vitest.config.ts
      - "app/**"
      - "tests/**"
      - "packages/proxmox-openapi/**"
      - "packages/**"
  push:
    branches:
      - main
    paths:
      - .github/workflows/automation-pipeline.yml
      - package.json
      - package-lock.json
      - biome.json
      - tsconfig.json
      - vite.config.ts
      - vitest.config.ts
      - "app/**"
      - "tests/**"
      - "packages/proxmox-openapi/**"
      - "packages/**"
  workflow_dispatch:
    inputs:
      run_linux:
        description: "Run Linux smoke test"
        default: "true"
        required: false
      run_macos:
        description: "Run macOS smoke test"
        default: "false"
        required: false
      run_windows:
        description: "Run Windows smoke test"
        default: "false"
        required: false

jobs:
  pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 24
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build automation package
        run: npm run build --workspace packages/proxmox-openapi

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps --only-shell

      - name: Run proxmox-openapi pipeline
        run: node packages/proxmox-openapi/dist/cli.cjs pipeline --mode full --report var/automation-summary.json

      - name: Validate generated OpenAPI document
        run: npm run openapi:validate

      - name: Build
        run: npm run build

      - name: Run unit suites
        run: |
          npm run normalizer:test
          npm run openapi:test
          npm run ui:test

      - name: Upload OpenAPI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: proxmox-openapi
          path: |
            var/openapi/proxmox-ve.json
            var/openapi/proxmox-ve.yaml
            var/automation-summary.json
          if-no-files-found: error

  action-lint:
    name: Lint composite action
    runs-on: ubuntu-latest
    needs: pipeline
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        run: npm install
      - name: Run action lint
        run: npm run action:lint

  smoke-linux:
    name: Smoke test (Linux)
    needs:
      - pipeline
      - action-lint
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.run_linux == 'true'
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        shell: bash
        run: npm install
      - name: Build automation package
        shell: bash
        run: npm run build --workspace packages/proxmox-openapi
      - name: Run smoke test
        id: pipeline
        uses: ./.github/actions/proxmox-openapi-artifacts
        with:
          mode: ci
          install-command: ""
          install-playwright-browsers: true
          report-path: var/automation-summary.json
      - name: Inspect outputs
        shell: bash
        run: |
          set -euo pipefail
          echo "Raw snapshot: ${{ steps.pipeline.outputs.raw-snapshot }}"
          echo "Normalized document: ${{ steps.pipeline.outputs.normalized-document }}"
          echo "OpenAPI JSON: ${{ steps.pipeline.outputs.openapi-json }}"
          echo "OpenAPI YAML: ${{ steps.pipeline.outputs.openapi-yaml }}"

  smoke-macos:
    name: Smoke test (macOS)
    needs:
      - pipeline
      - action-lint
    runs-on: macos-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_macos == 'true'
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        shell: bash
        run: npm install
      - name: Build automation package
        shell: bash
        run: npm run build --workspace packages/proxmox-openapi
      - name: Run smoke test
        id: pipeline
        uses: ./.github/actions/proxmox-openapi-artifacts
        with:
          mode: ci
          install-command: ""
          install-playwright-browsers: true
          report-path: var/automation-summary.json
      - name: Inspect outputs
        shell: bash
        run: |
          set -euo pipefail
          echo "Raw snapshot: ${{ steps.pipeline.outputs.raw-snapshot }}"
          echo "Normalized document: ${{ steps.pipeline.outputs.normalized-document }}"
          echo "OpenAPI JSON: ${{ steps.pipeline.outputs.openapi-json }}"
          echo "OpenAPI YAML: ${{ steps.pipeline.outputs.openapi-yaml }}"

  smoke-windows:
    name: Smoke test (Windows)
    needs:
      - pipeline
      - action-lint
    runs-on: windows-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_windows == 'true'
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        shell: bash
        run: npm install
      - name: Build automation package
        shell: bash
        run: npm run build --workspace packages/proxmox-openapi
      - name: Run smoke test
        id: pipeline
        uses: ./.github/actions/proxmox-openapi-artifacts
        with:
          mode: ci
          install-command: ""
          install-playwright-browsers: true
          report-path: var/automation-summary.json
      - name: Inspect outputs
        shell: bash
        run: |
          set -euo pipefail
          echo "Raw snapshot: ${{ steps.pipeline.outputs.raw-snapshot }}"
          echo "Normalized document: ${{ steps.pipeline.outputs.normalized-document }}"
          echo "OpenAPI JSON: ${{ steps.pipeline.outputs.openapi-json }}"
          echo "OpenAPI YAML: ${{ steps.pipeline.outputs.openapi-yaml }}"
