name: release

on:
  release:
    types:
      - published

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.normalize.outputs.version }}
      tag: ${{ steps.normalize.outputs.tag }}
    steps:
      - name: Derive release version
        id: normalize
        env:
          RAW_TAG: ${{ github.event.release.tag_name }}
        run: |
          set -euo pipefail
          if [ -z "${RAW_TAG}" ]; then
            echo "Release tag missing from event payload" >&2
            exit 1
          fi

          TAG="${RAW_TAG}"
          VERSION="${TAG#v}"

          if ! [[ "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Release tag '${TAG}' must follow the format 'vX.Y.Z' to be publishable to npm." >&2
            exit 1
          fi

          echo "Using release version ${VERSION}"
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "tag=v${VERSION}" >> "${GITHUB_OUTPUT}"

  publish-package:
    needs: prepare
    runs-on: ubuntu-latest
    env:
      NODE_AUTH_TOKEN: ${{ secrets.RELEASE }}
    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: package-lock.json
          registry-url: https://npm.pkg.github.com

      - name: Configure npm authentication
        run: |
          cat <<'RC' >> ~/.npmrc
          //npm.pkg.github.com/:_authToken=${NODE_AUTH_TOKEN}
          @mihailfox:registry=https://npm.pkg.github.com
          RC

      - name: Remove deprecated npm config flags
        run: npm config delete always-auth --location=user || true

      - name: Align package version
        env:
          RELEASE_VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          set -euo pipefail
          npm version "${RELEASE_VERSION}" --workspace packages/proxmox-openapi --no-git-tag-version

      - name: Install dependencies
        run: npm install --workspaces --include-workspace-root

      - name: Build CLI workspace
        run: npm run build --workspace packages/proxmox-openapi

      - name: Publish package
        run: npm publish --workspace packages/proxmox-openapi --provenance --access public

      - name: Wait for package availability
        env:
          RELEASE_VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          set -euo pipefail
          REGISTRY="https://npm.pkg.github.com"
          for attempt in {1..10}; do
            if npm view "@mihailfox/proxmox-openapi@${RELEASE_VERSION}" version --registry="${REGISTRY}"; then
              exit 0
            fi
            sleep 10
          done
          echo "Package version ${RELEASE_VERSION} not visible yet" >&2
          exit 1

  generate-openapi:
    needs:
      - prepare
      - publish-package
    runs-on: ubuntu-latest
    env:
      NODE_AUTH_TOKEN: ${{ secrets.RELEASE }}
    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: package-lock.json
          registry-url: https://npm.pkg.github.com

      - name: Configure npm authentication
        run: |
          cat <<'RC' >> ~/.npmrc
          //npm.pkg.github.com/:_authToken=${NODE_AUTH_TOKEN}
          @mihailfox:registry=https://npm.pkg.github.com
          RC
      - name: Install dependencies
        run: npm install --workspaces --include-workspace-root

      - name: Install Playwright browsers
        run: npx playwright install chromium chromium-headless-shell --with-deps

      - name: Install published CLI
        env:
          RELEASE_VERSION: ${{ needs.prepare.outputs.version }}
        run: npm install --global "@mihailfox/proxmox-openapi@${RELEASE_VERSION}"

      - name: Verify CLI availability
        run: proxmox-openapi --help >/dev/null

      - name: Generate OpenAPI artifacts
        run: proxmox-openapi pipeline --mode=full --report var/automation-summary.json

      - name: Validate OpenAPI document
        run: npm run openapi:validate

      - name: Prepare release payload
        env:
          RELEASE_TAG: ${{ needs.prepare.outputs.tag }}
        run: |
          set -euo pipefail
          npm run openapi:release:prepare -- "${RELEASE_TAG}"
          STAGING_DIR="var/openapi-release/proxmox-openapi-schema-${RELEASE_TAG}"
          RELEASE_NOTES="var/openapi-release/RELEASE_NOTES-${RELEASE_TAG}.md"
          test -f "${RELEASE_NOTES}"
          (cd var/openapi-release && tar -czf "proxmox-openapi-schema-${RELEASE_TAG}.tgz" "proxmox-openapi-schema-${RELEASE_TAG}")
          (cd var/openapi-release && zip -r "proxmox-openapi-schema-${RELEASE_TAG}.zip" "proxmox-openapi-schema-${RELEASE_TAG}")

      - name: Publish OpenAPI assets
        uses: softprops/action-gh-release@v2
        with:
          name: Proxmox OpenAPI ${{ needs.prepare.outputs.tag }}
          body_path: var/openapi-release/RELEASE_NOTES-${{ needs.prepare.outputs.tag }}.md
          files: |
            var/openapi-release/proxmox-openapi-schema-${{ needs.prepare.outputs.tag }}.tgz
            var/openapi-release/proxmox-openapi-schema-${{ needs.prepare.outputs.tag }}.zip
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-action:
    needs:
      - prepare
      - publish-package
      - generate-openapi
    runs-on: ubuntu-latest
    env:
      NODE_AUTH_TOKEN: ${{ secrets.RELEASE }}
    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: package-lock.json
          registry-url: https://npm.pkg.github.com

      - name: Configure npm authentication
        run: |
          cat <<'RC' >> ~/.npmrc
          //npm.pkg.github.com/:_authToken=${NODE_AUTH_TOKEN}
          @mihailfox:registry=https://npm.pkg.github.com
          RC
      - name: Install dependencies
        run: npm install --workspaces --include-workspace-root

      - name: Ensure legacy workspace symlink
        run: |
          set -euo pipefail
          mkdir -p .github/packages
          ln -sfn ../../packages/proxmox-openapi .github/packages/proxmox-openapi

      - name: Use published CLI in action workspace
        env:
          RELEASE_VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          set -euo pipefail
          npm uninstall --workspace .github/actions/proxmox-openapi-artifacts @mihailfox/proxmox-openapi || true
          npm install --workspace .github/actions/proxmox-openapi-artifacts "@mihailfox/proxmox-openapi@${RELEASE_VERSION}"

      - name: Lint action workspace
        run: npm run action:lint

      - name: Package action artifacts
        env:
          RELEASE_TAG: ${{ needs.prepare.outputs.tag }}
        run: |
          set -euo pipefail
          STAGING_DIR="var/action-bundle/proxmox-openapi-artifacts-action"
          mkdir -p "${STAGING_DIR}"
          cp .github/actions/proxmox-openapi-artifacts/action.yml "${STAGING_DIR}/action.yml"
          cp .github/actions/proxmox-openapi-artifacts/README.md "${STAGING_DIR}/README.md"
          cp .github/actions/proxmox-openapi-artifacts/main.mjs "${STAGING_DIR}/main.mjs"
          cp .github/actions/proxmox-openapi-artifacts/package.json "${STAGING_DIR}/package.json"
          (cd var/action-bundle && tar -czf "proxmox-openapi-artifacts-action-${RELEASE_TAG}.tgz" proxmox-openapi-artifacts-action)
          (cd var/action-bundle && zip -r "proxmox-openapi-artifacts-action-${RELEASE_TAG}.zip" proxmox-openapi-artifacts-action)

      - name: Upload action assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            var/action-bundle/proxmox-openapi-artifacts-action-${{ needs.prepare.outputs.tag }}.tgz
            var/action-bundle/proxmox-openapi-artifacts-action-${{ needs.prepare.outputs.tag }}.zip
          fail_on_unmatched_files: true
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
