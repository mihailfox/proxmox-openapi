#!/usr/bin/env bash
set -euo pipefail

SCRIPTS_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=scripts/common.sh
source "${SCRIPTS_DIR}/../scripts/common.sh"

if ! command -v npx >/dev/null 2>&1; then
  log "npx not found; skipping Biome formatting." >&2
  exit 0
fi

if ! npm ls --depth=0 @biomejs/biome >/dev/null 2>&1; then
  log "@biomejs/biome not installed; skipping Biome formatting." >&2
  exit 0
fi

if git status --short | grep --quiet '^MM'; then
  err '%s\n' "ERROR: Some staged files have unstaged changes" >&2
  exit 1;
fi

npx @biomejs/biome check --write --staged --files-ignore-unknown=true --no-errors-on-unmatched

# Link-check staged Markdown files
if command -v node >/dev/null 2>&1; then
  mapfile -t STAGED_MD < <(git diff --cached --name-only --diff-filter=ACMRT | grep -E '\.md$' || true)
  if ((${#STAGED_MD[@]})); then
    log "Checking Markdown links for staged files..."
    node scripts/check-doc-links.mjs "${STAGED_MD[@]}"
  fi
fi

git update-index --again
